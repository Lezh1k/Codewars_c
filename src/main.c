#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <math.h>

#define maxord 12

#ifdef MAGNETIC_COFF_FILE
static double sp[13];
static double cp[13];
static double fn[13];
static double fm[13];

static double k[13][13];
static double c[13][13];
static double cd[13][13];
static double snorm2d[13][13];
#else
static double sp[13] = {
  0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
};

static double cp[13] = {
  1.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000
};

static double fn[13] = {
  0.000000, 2.000000, 3.000000, 4.000000, 5.000000, 6.000000, 7.000000, 8.000000, 9.000000, 10.000000, 11.000000, 12.000000, 13.000000
};

static double fm[13] = {
  0.000000, 1.000000, 2.000000, 3.000000, 4.000000, 5.000000, 6.000000, 7.000000, 8.000000, 9.000000, 10.000000, 11.000000, 12.000000
};
///////////////////////////////////////////////////////

static double k[13][13] = {
  {0.000000, -0.000000, 0.333333, 0.266667, 0.257143, 0.253968, 0.252525, 0.251748, 0.251282, 0.250980, 0.250774, 0.250627, 0.250518},
  {0.000000, 0.000000, 0.000000, 0.200000, 0.228571, 0.238095, 0.242424, 0.244755, 0.246154, 0.247059, 0.247678, 0.248120, 0.248447},
  {0.000000, 0.000000, -1.000000, 0.000000, 0.142857, 0.190476, 0.212121, 0.223776, 0.230769, 0.235294, 0.238390, 0.240602, 0.242236},
  {0.000000, 0.000000, 0.000000, -0.333333, 0.000000, 0.111111, 0.161616, 0.188811, 0.205128, 0.215686, 0.222910, 0.228070, 0.231884},
  {0.000000, 0.000000, 0.000000, 0.000000, -0.200000, 0.000000, 0.090909, 0.139860, 0.169231, 0.188235, 0.201238, 0.210526, 0.217391},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.142857, 0.000000, 0.076923, 0.123077, 0.152941, 0.173375, 0.187970, 0.198758},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.111111, 0.000000, 0.066667, 0.109804, 0.139319, 0.160401, 0.175983},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.090909, 0.000000, 0.058824, 0.099071, 0.127820, 0.149068},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.076923, 0.000000, 0.052632, 0.090226, 0.118012},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.066667, 0.000000, 0.047619, 0.082816},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.058824, 0.000000, 0.043478},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.052632, 0.000000},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, -0.047619},
};

static double c[13][13] = {
  {0.000000, -29438.200000, -3666.750000, 3379.500000, 3970.312500, -1834.087500, 1001.962500, 2190.581250, 1216.617188, 522.285156, -360.851562, 1033.347656, -1320.388672},
  {4796.300000, -1493.500000, 5221.613570, -7200.275099, 4509.091716, 3660.985920, 1279.741545, -2692.142907, 596.578125, 1121.150508, -1484.045050, -652.941026, -89.702746},
  {-4923.181215, -553.217028, 1454.056653, 2369.491211, 460.965414, 1473.255346, 1080.467993, -205.621751, -947.792009, 325.950125, 42.138384, -940.810339, 397.564930},
  {-348.133730, 477.345197, -424.852004, 460.348570, -701.957762, -664.987847, -1286.200257, 1068.971704, -128.400677, -265.545088, 99.168204, 688.732817, 779.064975},
  {1567.778207, -738.014236, 377.961167, -244.038291, 51.543845, -348.752903, -154.974883, 185.233963, -553.439746, 33.825443, -58.435425, -191.611175, -438.224049},
  {476.812662, 1510.144369, -564.274897, 35.496479, 70.577012, 5.402018, 31.644668, 56.187635, 197.246797, -444.720509, 133.048108, 95.054159, 300.619217},
  {-379.952807, 490.170818, 588.802751, -366.155446, 18.847192, 41.577815, -47.220038, -7.265474, 79.636638, -1.739793, -28.924060, -65.882350, 20.829891},
  {-1925.999471, -564.735795, 122.870311, 302.548806, 21.610629, -67.084541, -1.877054, 3.818833, -40.861274, 65.541667, 44.095008, 4.960435, 70.232329},
  {677.015625, -1026.307323, 550.880325, -387.675184, 240.255498, 41.191365, -23.062805, 1.504096, -1.316084, -23.514197, 19.638231, 38.692065, -23.410776},
  {-2777.395578, 1162.555445, 979.197512, -383.355021, -232.467539, 137.443652, 7.533525, -10.077513, 5.176920, -6.334114, -4.778613, -1.762985, -12.771626},{802.844044, -84.276768, 760.289566, 514.231738, -583.933361, -24.792051, -84.181378, -23.729529, -2.920263, -5.223926, -2.137061, 1.088138, 1.886494},
  {-0.000000, 859.000744, -196.780805, -263.465365, 110.896519, -18.823528, -104.169141, -34.140057, -22.918805, -5.440690, -1.333953, 2.029928, -2.503335},
  {-897.027462, 238.538958, 1168.597463, -1071.214341, 100.206406, 145.809237, -11.705388, 17.558082, 5.108650, -8.489224, -0.556297, 0.454214, -0.000000},
};

static double cd[13][13] = {
  {0.000000, 7.000000, -16.500000, 6.000000, -3.500000, -2.362500, -11.550000, -8.043750, -5.027344, -9.496094, 0.000000, -0.000000, 0.000000},
  {-30.200000, 9.000000, -10.738715, -17.452614, -4.980587, 6.099949, -9.451562, -7.093921, 13.406250, -12.740347, -0.000000, 0.000000, 0.000000},
  {-51.268704, -14.982239, 0.259808, 3.872983, -25.435273, -6.148170, -1.494423, -8.688243, -11.216473, -0.000000, -21.069192, -0.000000, -0.000000},
  {19.902104, -1.549193, -1.581139, -8.696264, 10.876580, 0.470621, 15.940514, 18.430547, 20.709787, 33.193136, 33.056068, 0.000000, 0.000000},
  {-2.213594, 22.696090, 7.948270, -2.588285, -2.958040, 2.662236, -8.730979, 1.234893, -2.673622, -22.550295, -11.687085, -0.000000, -48.691561},
  {2.033316, 17.675990, -0.000000, 7.321149, -0.420936, 0.982185, 0.000000, -3.704679, 5.932235, 0.000000, -14.783123, -15.842360, -0.000000},
  {5.670937, -22.416348, -11.955386, 2.182745, 0.465363, 0.873201, 0.806032, -2.179642, 2.746091, 5.219379, -0.000000, 0.000000, 0.000000},
  {21.281762, 14.480405, -16.382708, -2.469786, -6.791912, 0.242182, 0.129452, 0.453082, -0.250683, 0.000000, -2.004319, -0.000000, -0.000000},
  {-26.812500, 33.649420, -4.141957, 16.041732, -2.966117, -3.432614, 1.253413, 0.062671, 0.250683, -0.000000, -1.636519, -0.000000, 0.000000},
  {-38.221040, 10.865004, -33.193136, 16.912722, 3.369095, -0.000000, -0.753352, 1.291989, 0.121810, -0.182715, -0.265478, -0.881492, -0.000000},
  {0.000000, 21.069192, -33.056068, 11.687085, -7.391562, 4.132009, -0.000000, -0.818260, 0.530957, -0.000000, -0.000000, -0.000000, -0.000000},
  {0.000000, 40.904797, 0.000000, 23.951397, -0.000000, -0.000000, 4.960435, -0.000000, -0.881492, -0.000000, -0.057998, -0.057998, -0.000000},
  {-0.000000, 0.000000, -64.922081, 48.691561, -0.000000, 0.000000, -0.000000, 0.000000, 0.000000, -0.000000, 0.000000, -0.056777, -0.056777},
};

static double snorm2d[13][13] = {
  {1.000000, 1.000000, 1.500000, 2.500000, 4.375000, 7.875000, 14.437500, 26.812500, 50.273438, 94.960938, 180.425781, 344.449219, 660.194336},
  {0.000000, 1.000000, 1.732051, 3.061862, 5.533986, 10.166581, 18.903125, 35.469604, 67.031250, 127.403467, 243.286074, 466.386447, 897.027462},
  {0.000000, 0.000000, 0.866025, 1.936492, 3.913119, 7.685213, 14.944232, 28.960810, 56.082367, 108.650042, 210.691920, 409.047973, 795.129861},
  {0.000000, 0.000000, 0.000000, 0.790569, 2.091650, 4.706213, 9.962822, 20.478385, 41.419573, 82.982840, 165.280340, 327.968008, 649.220813},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.739510, 2.218530, 5.456862, 12.348931, 26.736220, 56.375738, 116.870850, 239.513968, 486.915609},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.701561, 2.326814, 6.174465, 14.830586, 33.690948, 73.915615, 158.423599, 334.021352},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.671693, 2.421825, 6.865227, 17.397931, 41.320085, 94.117642, 208.298910},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.647260, 2.506827, 7.533525, 20.043185, 49.604353, 117.053882},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.626707, 2.583978, 8.182596, 22.760038, 58.526941},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.609049, 2.654785, 8.814925, 25.543251},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.593628, 2.720345, 9.432471},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.579979, 2.781484},
  {0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.000000, 0.567768},
};
#endif

static void initFromFile(const char *path);
static void calculate(double epoch, double alt, double glat, double glon,
                      double time, double *dec, double *dip,
                      double *ti, double *gv);

int main(int argc, char **argv) {
  (void)argc;
  (void)argv;
  static const char *path = "/home/lezh1k/SRC/WMM2015LegacyC/WMM.COF";
  double dec, dip, ti, gv;

#ifdef MAGNETIC_COFF_FILE
  initFromFile(path);
#endif

  calculate(2015.0, 0.0, 42.879965, 74.617977, 2019.0, &dec, &dip, &ti, &gv);
  printf("dec : %f\n", dec);
}
///////////////////////////////////////////////////////

void initFromFile(const char *path) {
  FILE *wmmdat;
  double epoch;
  int n, m, j, D1, D2;
  double gnm, hnm, dgnm, dhnm, flnmj;
  static char model[20], c_str[81], c_new[5];

  wmmdat = fopen(path, "r");
  if (wmmdat == NULL) {
    fprintf(stderr, "Error opening model file \n");
    exit(1);
  }

  /* INITIALIZE CONSTANTS */
  sp[0] = 0.0;
  cp[0] = 1.0;
  snorm2d[0][0] = 1.0;

  /* READ WORLD MAGNETIC MODEL SPHERICAL HARMONIC COEFFICIENTS */
  c[0][0] = 0.0;
  cd[0][0] = 0.0;

  fgets(c_str, 80, wmmdat);
  if (sscanf(c_str,"%lf%s", &epoch, model) < 2) {
    fprintf(stderr, "Invalid header in model file WMM.COF\n");
    exit(1);
  }

  while (1) {
    if (fgets(c_str, 80, wmmdat) == NULL)
      break;

    /* CHECK FOR LAST LINE IN FILE */
    for (int i=0; i<4 && (c_str[i] != '\0'); i++) {
      c_new[i] = c_str[i];
      c_new[i+1] = '\0';
    }

    if (strcmp("9999", c_new) == 0)
      break;

    /* END OF FILE NOT ENCOUNTERED, GET VALUES */
    sscanf(c_str,"%d%d%lf%lf%lf%lf",&n,&m,&gnm,&hnm,&dgnm,&dhnm);

    if (n > maxord)
      break;

    if (m > n || m < 0.0) {
      fprintf(stderr, "Corrupt record in model file WMM.COF\n");
      exit(1);
    }

    if (m <= n) {
      c[m][n] = gnm;
      cd[m][n] = dgnm;
      if (m != 0) {
        c[n][m-1] = hnm;
        cd[n][m-1] = dhnm;
      }
    } //if (m <= n)
  } //while true

  /* CONVERT SCHMIDT NORMALIZED GAUSS COEFFICIENTS TO UNNORMALIZED */
  snorm2d[0][0] = 1.0;
  fm[0] = 0.0;
  for (n=1; n<=maxord; n++) {
    snorm2d[0][n] = snorm2d[0][n-1] * (double)(2*n-1)/(double)n;
    j = 2;
    for (m=0,D1=1,D2=(n-m+D1)/D1; D2>0; D2--,m+=D1) {
      k[m][n] = (double)(((n-1)*(n-1))-(m*m))/(double)((2*n-1)*(2*n-3));
      if (m > 0) {
        flnmj = (double)((n-m+1)*j)/(double)(n+m);
        snorm2d[m][n] = snorm2d[m-1][n]*sqrt(flnmj);
        j = 1;

        c[n][m-1] *= snorm2d[m][n];
        cd[n][m-1] *= snorm2d[m][n];
      }
      c[m][n] *= snorm2d[m][n];
      cd[m][n] *= snorm2d[m][n];
    }
    fn[n] = (double)(n+1);
    fm[n] = (double)n;
  }
  k[1][1] = 0.0;

  fclose(wmmdat);
  return;
}
///////////////////////////////////////////////////////

void calculate(double epoch, double alt, double glat, double glon,
               double time, double *dec, double *dip,
               double *ti, double *gv) {

#define a   6378.137
#define b   6356.7523142
#define re  6371.2
#define a2  (a*a)
#define b2  (b*b)
#define c2  (a2-b2)
#define a4  (a2*a2)
#define b4  (b2*b2)
#define c4  (a4-b4)
#define pi M_PI
#define dtr (pi/180.0)

  int n, m, D3, D4;
  double pp[13];
  double tc[13][13];
  double dp[13][13];
  double dt;
  double rlon, rlat;
  double srlon, srlat;
  double crlon, crlat;
  double srlat2, crlat2;
  double q, q1, q2, ct, st, r2, r;
  double d, ca, sa, aor, ar, br, bt;
  double bp, bpp, par, temp1, temp2;
  double parp, bx, by, bz, bh;

  pp[0] = 1.0;
  dp[0][0] = 0.0;

  dt = time - epoch;
  rlon = glon*dtr;
  rlat = glat*dtr;
  srlon = sin(rlon);
  srlat = sin(rlat);
  crlon = cos(rlon);
  crlat = cos(rlat);
  srlat2 = srlat*srlat;
  crlat2 = crlat*crlat;
  sp[1] = srlon;
  cp[1] = crlon;

  //CONVERT FROM GEODETIC COORDS. TO SPHERICAL COORDS.
  q = sqrt(a2 - c2*srlat2);
  q1 = alt*q;
  q2 = ((q1+a2)/(q1+b2))*((q1+a2)/(q1+b2));
  ct = srlat/sqrt(q2*crlat2+srlat2);
  st = sqrt(1.0 - (ct*ct));
  r2 = (alt*alt) + 2.0*q1 + (a4 - c4*srlat2)/(q*q);
  r = sqrt(r2);
  d = sqrt(a2*crlat2 + b2*srlat2);
  ca = (alt + d)/r;
  sa = c2*crlat*srlat/(r*d);

  for (m=2; m<=maxord; m++) {
    sp[m] = sp[1]*cp[m-1] + cp[1]*sp[m-1];
    cp[m] = cp[1]*cp[m-1] - sp[1]*sp[m-1];
  }

  aor = re/r;
  ar = aor*aor;
  br = bt = bp = bpp = 0.0;
  for (n=1; n<=maxord; n++) {
    ar = ar*aor;
    for (m=0, D3=1 , D4=(n+m+D3)/D3; D4>0; D4--, m+=D3) {

      //COMPUTE UNNORMALIZED ASSOCIATED LEGENDRE POLYNOMIALS
      //AND DERIVATIVES VIA RECURSION RELATIONS
      do {
        if (n == m) {
          snorm2d[m][n] = st * snorm2d[m-1][n-1];
          dp[m][n] = st * dp[m-1][n-1] + ct * snorm2d[m-1][n-1];
          break;
        }

        if (n == 1 && m == 0) {
          snorm2d[m][n] = ct * snorm2d[m][n-1];
          dp[m][n] = ct*dp[m][n-1] - st*snorm2d[m][n-1];
          break;
        }

        if (n > 1 && n != m) {
          if (m > n-2) snorm2d[m][n-2] = 0.0;
          if (m > n-2) dp[m][n-2] = 0.0;
          snorm2d[m][n] = ct * snorm2d[m][n-1] - k[m][n]*snorm2d[m][n-2];
          dp[m][n] = ct*dp[m][n-1] - st*snorm2d[m][n-1] - k[m][n]*dp[m][n-2];
        }
      } while(0);

      //TIME ADJUST THE GAUSS COEFFICIENTS
      tc[m][n] = c[m][n]+dt*cd[m][n];
      if (m != 0)
        tc[n][m-1] = c[n][m-1]+dt*cd[n][m-1];

      //ACCUMULATE TERMS OF THE SPHERICAL HARMONIC EXPANSIONS
      par = ar * snorm2d[m][n];
      if (m == 0) {
        temp1 = tc[m][n]*cp[m];
        temp2 = tc[m][n]*sp[m];
      } else {
        temp1 = tc[m][n]*cp[m]+tc[n][m-1]*sp[m];
        temp2 = tc[m][n]*sp[m]-tc[n][m-1]*cp[m];
      }

      bt = bt-ar*temp1*dp[m][n];
      bp += (fm[m]*temp2*par);
      br += (fn[n]*temp1*par);

      //SPECIAL CASE:  NORTH/SOUTH GEOGRAPHIC POLES
      if (st == 0.0 && m == 1) {
        if (n == 1)
          pp[n] = pp[n-1];
        else
          pp[n] = ct*pp[n-1] - k[m][n]*pp[n-2];
        parp = ar*pp[n];
        bpp += fm[m] * temp2 * parp;
      }
    }
  }
  if (st == 0.0) bp = bpp;
  else bp /= st;

  //ROTATE MAGNETIC VECTOR COMPONENTS FROM SPHERICAL TO
  //GEODETIC COORDINATES
  bx = -bt*ca - br*sa;
  by = bp;
  bz = bt*sa - br*ca;

  //COMPUTE DECLINATION (DEC), INCLINATION (DIP) AND
  //TOTAL INTENSITY (TI)
  bh = sqrt((bx*bx)+(by*by));
  *ti = sqrt((bh*bh)+(bz*bz));
  *dec = atan2(by,bx)/dtr;
  *dip = atan2(bz,bh)/dtr;

  //COMPUTE MAGNETIC GRID VARIATION IF THE CURRENT
  //GEODETIC POSITION IS IN THE ARCTIC OR ANTARCTIC
  //(I.E. GLAT > +55 DEGREES OR GLAT < -55 DEGREES)
  //OTHERWISE, SET MAGNETIC GRID VARIATION TO -999.0
  *gv = -999.0;
  if (fabs(glat) >= 55.)
  {
    if (glat > 0.0 && glon >= 0.0) *gv = *dec-glon;
    if (glat > 0.0 && glon < 0.0) *gv = *dec+fabs(glon);
    if (glat < 0.0 && glon >= 0.0) *gv = *dec+glon;
    if (glat < 0.0 && glon < 0.0) *gv = *dec-fabs(glon);
    if (*gv > +180.0) *gv -= 360.0;
    if (*gv < -180.0) *gv += 360.0;
  }

  return;
}
///////////////////////////////////////////////////////
